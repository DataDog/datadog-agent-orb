version: 2.1

description: Installs and runs the Datadog Agent in the background
display:
  home_url: "https://docs.datadoghq.com/continuous_integration/"

commands:
      setup:
        description: "Installs and starts the Datadog Agent"
        steps:
          - run:
              name: Install and start the Datadog Agent
              command: |
                DD_API_KEY=${DD_API_KEY} DD_AGENT_MAJOR_VERSION=${DD_AGENT_MAJOR_VERSION-7} DD_SITE=${DD_SITE-datadoghq.com} \
                  DD_HOSTNAME="none" DD_INSTALL_ONLY="true" \
                  bash -c "$(curl -L https://s3.amazonaws.com/dd-agent/scripts/install_script.sh)"
                if [ "$(echo "$UID")" = "0" ]; then export SUDO=''; else export SUDO='sudo'; fi
                $SUDO find /etc/datadog-agent/conf.d/ -iname "*.yaml.default" -delete
                $SUDO service datadog-agent start
              working_directory: /tmp
      stop:
        description: "Gracefully stops the Datadog Agent"
        steps:
          - run:
              name: Gracefully stop the Datadog Agent
              command: |
                if [ "$(echo "$UID")" = "0" ]; then export SUDO=''; else export SUDO='sudo'; fi
                $SUDO service datadog-agent stop
              when: always
